var ReconnectingWebSocket=function(){"use strict";var o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function e(e,t){function n(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function t(e,t){this.target=t,this.type=e}var r,n=(e(i,r=t),i);function i(e,t){var n=r.call(this,"error",t)||this;return n.message=e.message,n.error=e,n}var s,c=(e(u,s=t),u);function u(e,t,n){void 0===e&&(e=1e3),void 0===t&&(t="");var o=s.call(this,"close",n)||this;return o.wasClean=!0,o.code=e,o.reason=t,o}var a={maxReconnectionDelay:1e3,minReconnectionDelay:500,minUptime:5e3,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,debug:!1};function _(e,t,n){var o=this;void 0===n&&(n={}),this._listeners={error:[],message:[],open:[],close:[]},this._retryCount=-1,this._shouldReconnect=!0,this._connectLock=!1,this._binaryType="blob",this._closeCalled=!1,this._messageQueue=[],this.onclose=void 0,this.onerror=void 0,this.onmessage=void 0,this.onopen=void 0,this._handleOpen=function(t){o._debug("open event");var e=o._options.minUptime,n=void 0===e?a.minUptime:e;clearTimeout(o._connectTimeout),o._uptimeTimeout=setTimeout(function(){return o._acceptOpen()},n),o._ws.binaryType=o._binaryType,o._messageQueue.forEach(function(e){return o._ws.send(e)}),o._messageQueue=[],o.onopen&&o.onopen(t),o._listeners.open.forEach(function(e){return o._callEventListener(t,e)})},this._handleMessage=function(t){o._debug("message event"),o.onmessage&&o.onmessage(t),o._listeners.message.forEach(function(e){return o._callEventListener(t,e)})},this._handleError=function(t){o._debug("error event",t.message),o._disconnect(void 0,"TIMEOUT"===t.message?"timeout":void 0),o.onerror&&o.onerror(t),o._debug("exec error listeners"),o._listeners.error.forEach(function(e){return o._callEventListener(t,e)}),o._connect()},this._handleClose=function(t){o._debug("close event"),o._clearTimeouts(),o._shouldReconnect&&o._connect(),o.onclose&&o.onclose(t),o._listeners.close.forEach(function(e){return o._callEventListener(t,e)})},this._url=e,this._protocols=t,this._options=n,this._connect()}return Object.defineProperty(_,"CONNECTING",{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(_,"OPEN",{get:function(){return 1},enumerable:!0,configurable:!0}),Object.defineProperty(_,"CLOSING",{get:function(){return 2},enumerable:!0,configurable:!0}),Object.defineProperty(_,"CLOSED",{get:function(){return 3},enumerable:!0,configurable:!0}),Object.defineProperty(_.prototype,"CONNECTING",{get:function(){return _.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(_.prototype,"OPEN",{get:function(){return _.OPEN},enumerable:!0,configurable:!0}),Object.defineProperty(_.prototype,"CLOSING",{get:function(){return _.CLOSING},enumerable:!0,configurable:!0}),Object.defineProperty(_.prototype,"CLOSED",{get:function(){return _.CLOSED},enumerable:!0,configurable:!0}),Object.defineProperty(_.prototype,"binaryType",{get:function(){return this._ws?this._ws.binaryType:this._binaryType},set:function(e){this._binaryType=e,this._ws&&(this._ws.binaryType=e)},enumerable:!0,configurable:!0}),Object.defineProperty(_.prototype,"retryCount",{get:function(){return Math.max(this._retryCount,0)},enumerable:!0,configurable:!0}),Object.defineProperty(_.prototype,"bufferedAmount",{get:function(){return this._messageQueue.reduce(function(e,t){return"string"==typeof t?e+=t.length:t instanceof Blob?e+=t.size:e+=t.byteLength,e},0)+(this._ws?this._ws.bufferedAmount:0)},enumerable:!0,configurable:!0}),Object.defineProperty(_.prototype,"extensions",{get:function(){return this._ws?this._ws.extensions:""},enumerable:!0,configurable:!0}),Object.defineProperty(_.prototype,"protocol",{get:function(){return this._ws?this._ws.protocol:""},enumerable:!0,configurable:!0}),Object.defineProperty(_.prototype,"readyState",{get:function(){return this._ws?this._ws.readyState:_.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(_.prototype,"url",{get:function(){return this._ws?this._ws.url:""},enumerable:!0,configurable:!0}),_.prototype.close=function(e,t){void 0===e&&(e=1e3),this._closeCalled=!0,this._shouldReconnect=!1,this._clearTimeouts(),this._ws?this._ws.readyState!==this.CLOSED?this._ws.close(e,t):this._debug("close: already closed"):this._debug("close enqueued: no ws instance")},_.prototype.reconnect=function(e,t){this._shouldReconnect=!0,this._closeCalled=!1,this._retryCount=-1,this._ws&&this._ws.readyState!==this.CLOSED&&this._disconnect(e,t),this._connect()},_.prototype.send=function(e){this._ws&&this._ws.readyState===this.OPEN?(this._debug("send",e),this._ws.send(e)):(this._debug("enqueue",e),this._messageQueue.push(e))},_.prototype.addEventListener=function(e,t){this._listeners[e]&&this._listeners[e].push(t)},_.prototype.removeEventListener=function(e,t){this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter(function(e){return e!==t}))},_.prototype._debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._options.debug},_.prototype._getNextDelay=function(){var e=this._options,t=e.reconnectionDelayGrowFactor,n=void 0===t?a.reconnectionDelayGrowFactor:t,o=e.minReconnectionDelay,r=void 0===o?a.minReconnectionDelay:o,i=e.maxReconnectionDelay,s=void 0===i?a.maxReconnectionDelay:i,c=r;return 0<this._retryCount&&s<(c=r*Math.pow(n,this._retryCount-1))&&(c=s),this._debug("next delay",c),c},_.prototype._wait=function(){var t=this;return new Promise(function(e){setTimeout(e,t._getNextDelay())})},_.prototype._getNextUrl=function(e){if("string"==typeof e)return Promise.resolve(e);if("function"==typeof e){var t=e();if("string"==typeof t)return Promise.resolve(t);if(t.then)return t}throw Error("Invalid URL")},_.prototype._connect=function(){var t=this;if(!this._connectLock&&this._shouldReconnect){this._connectLock=!0;var e=this._options,n=e.maxRetries,o=void 0===n?a.maxRetries:n,r=e.connectionTimeout,i=void 0===r?a.connectionTimeout:r,s=e.WebSocket,c=void 0===s?function(){if("undefined"!=typeof WebSocket)return WebSocket}():s;if(this._retryCount>=o)this._debug("max retries reached",this._retryCount,">=",o);else{if(this._retryCount++,this._debug("connect",this._retryCount),this._removeListeners(),!function(e){return"function"==typeof e&&2===e.CLOSING}(c))throw Error("No valid WebSocket class provided");this._wait().then(function(){return t._getNextUrl(t._url)}).then(function(e){t._closeCalled?t._connectLock=!1:(t._debug("connect",{url:e,protocols:t._protocols}),t._ws=t._protocols?new c(e,t._protocols):new c(e),t._ws.binaryType=t._binaryType,t._connectLock=!1,t._addListeners(),t._connectTimeout=setTimeout(function(){return t._handleTimeout()},i))})}}},_.prototype._handleTimeout=function(){this._debug("timeout event"),this._handleError(new n(Error("TIMEOUT"),this))},_.prototype._disconnect=function(e,t){if(void 0===e&&(e=1e3),this._clearTimeouts(),this._ws){this._removeListeners();try{this._ws.close(e,t),this._handleClose(new c(e,t,this))}catch(e){}}},_.prototype._acceptOpen=function(){this._debug("accept open"),this._retryCount=0},_.prototype._callEventListener=function(e,t){"handleEvent"in t?t.handleEvent(e):t(e)},_.prototype._removeListeners=function(){this._ws&&(this._debug("removeListeners"),this._ws.removeEventListener("open",this._handleOpen),this._ws.removeEventListener("close",this._handleClose),this._ws.removeEventListener("message",this._handleMessage),this._ws.removeEventListener("error",this._handleError))},_.prototype._addListeners=function(){this._ws&&(this._debug("addListeners"),this._ws.addEventListener("open",this._handleOpen),this._ws.addEventListener("close",this._handleClose),this._ws.addEventListener("message",this._handleMessage),this._ws.addEventListener("error",this._handleError))},_.prototype._clearTimeouts=function(){clearTimeout(this._connectTimeout),clearTimeout(this._uptimeTimeout)},_}();